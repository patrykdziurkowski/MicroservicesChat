<div th:fragment="chatList" class="d-flex flex-column align-items-start h-100">
    <div th:replace="~{fragments/userSettingsModal.html :: userSettingsModal}"></div>
    <div th:replace="~{fragments/createChatModal.html :: createChatModal}"></div>
    <div th:replace="~{fragments/leaveChatModal.html :: leaveChatModal}"></div>
    <div th:replace="~{fragments/joinChatModal.html :: joinChatModal}"></div>
    <div id="serverContainer" class="scrollable-container">
    </div>
    <div class="d-flex justify-content-center mt-3 button-container" style="padding-left: 100px; padding-right: 155px; margin-bottom: 20px">
        <button class="btn btn-primary col" id="showCreateChatModal" data-bs-toggle="modal" data-bs-target="#createChat">Create Chat</button>
    </div>
    <section class="mt-auto row">
        <h5 class="col">Username</h5>
        <button class="btn btn-primary col" data-bs-toggle="modal" data-bs-target="#userSettings">Settings</button>
        <form class="col" th:action="@{/logout}" method="POST">
            <input id="logoutSubmit" type="submit" class="btn btn-primary" value="Logout">
        </form>
    </section>

    <script>
        let selectedChatId = null;
        let isSelectedChatPasswordProtected = false;
        document.addEventListener("DOMContentLoaded", () => {
            let offset = 0;

            function loadChats() {
                fetch(`/chats/load?offset=${offset}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => {
                        if (response.status === 204) {
                            console.log("No content received");
                            return [];
                        }

                        if (response.ok === false) {
                            throw new Error(`Failed to load chats: HTTP ${response.status}`);
                        }

                        return response.json();
                    })
                    .then(data => {
                        if (!data || data.length === 0) return;

                        console.log("Data received:", data);

                        const serverContainer = document.getElementById('serverContainer');

                data.forEach(chat => {
                    const section = createChatCard(chat);
                    serverContainer.appendChild(section);
                });
                let loadMoreButton = document.getElementById('loadMoreButton');
                if (loadMoreButton) {
                    loadMoreButton.remove();
                    loadMoreButton = null;
                }
                if (data.length === 20) {
                    offset += 20;
                    if (!loadMoreButton) {
                        createLoadMoreButton();
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

            function createLoadMoreButton() {
                const serverContainer = document.getElementById('serverContainer');
                const button = document.createElement('button');
                button.id = 'loadMoreButton';
                button.classList.add('btn', 'btn-secondary', 'mt-3', 'w-100');
                button.textContent = 'Load More';
                button.addEventListener('click', () => loadChats());
                serverContainer.appendChild(button);
            }

            loadChats();
        });
      
    function createChatCard(chat) {
        const section = document.createElement('section');
        section.classList.add('chat-card', 'p-3');
        section.style.cursor = 'pointer';
        section.setAttribute('data-chat-id', chat.id);

        section.innerHTML = cardText(chat);

        return section;
    }

    function cardText(chat) {
        return `
            <div class="d-flex justify-content-between align-items-center" onclick="if(${chat.isMember}) window.location.href = '/chats/${chat.id}'">
                <div>
                    <h5 class="card-title truncate-text">${chat.name}</h5>
                    <p class="card-text">${chat.memberCount} members</p>
                </div>

                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#${chat.isMember ? 'leaveChat' : 'joinChat'}"
                onclick="selectedChatId='${chat.id}';isSelectedChatPasswordProtected=${chat.isPasswordProtected};event.stopPropagation();">
                    ${chat.isMember ? 'Leave' : 'Join'}
                </button>
            </div>`;
    }

    </script>
</div>
